import Checkbox from"../vendors/rui/rui-checkbox.min.js";import Switch from"../vendors/rui/rui-switch.min.js";import Input from"../vendors/rui/rui-input.min.js";import Select from"../vendors/rui/rui-select.min.js";import Textarea from"../vendors/rui/rui-textarea.min.js";export default class{constructor(e){this.DataGridContainer=document.querySelector(`[data-grid="${e.table.dbName}"]`),this.TableName=e.table.name,this.Columns=e.columns,this.Rows=e.rows,this.RowIDs=e.rowIds,this.NumRows=e.numRows,this.CrudUrl=e.crudUrl,this.init()}init(){this.RPPVs=[5,10,25,50,100],this.RPPDV=25,this.ScrollbarWidth=15,this.Operations=[{value:"=",textContent:"equal"},{value:"!=",textContent:"not equal"},{value:">",textContent:"greater than"},{value:">=",textContent:"greater than or equal"},{value:"<",textContent:"less than"},{value:"<=",textContent:"less than or equal"},{value:"contain",textContent:"contain"},{value:"startWith",textContent:"start with"},{value:"endWith",textContent:"end with"},{value:"isEmpty",textContent:"is empty"},{value:"isNotEmpty",textContent:"is not empty"}],this.FilterTimer=null,this.DataGrid=document.createElement("datagrid-rui"),this.CreateAlert(),this.CreateToolbar(),this.CreateMain(),this.CreateFooter(),this.DataGridContainer.appendChild(this.DataGrid),this.SizeColumns(),this.SetupAllCheckbox(),this.SetupCheckboxes(),this.SetupResizingColumns(),this.SetupNextPrevBtns()}CreateAlert(){this.Alert=document.createElement("rwc-alert"),document.body.appendChild(this.Alert)}CreateToolbar(){this.Toolbar=document.createElement("toolbar-rui"),this.CreateColumnsPanelContainer(),this.CreateFiltersPanelContainer(),this.CreateSortsPanelContainer(),this.CreateNewModal(),this.CreateDeleteModal(),this.DataGrid.appendChild(this.Toolbar)}CreateColumnsPanelContainer(){const e=document.createElement("toolbar-panel-container-rui"),t=document.createElement("button");t.type="button",t.value=0,t.className="toolbar-btn",t.innerHTML='<i class="fas fa-columns"></i> Columns';const n=document.createElement("indicator-rui");n.className="hide",t.appendChild(n);const a=document.createElement("toolbar-panel-rui");a.className="columns hide";const s=document.createElement("panel-header-rui");s.appendChild(Input({attrs:{type:"text",placeholder:"Find Column"},evts:{input:function(){const e=a.querySelectorAll("label[data-switch-container]"),t=this.value.trim().toLowerCase();for(const n of e){n.children[1].textContent.trim().toLowerCase().indexOf(t)>-1?n.classList.remove("hide"):n.classList.add("hide")}}}}));const i=document.createElement("panel-content-rui"),o=this;for(let e=0;e<Object.keys(this.Columns).length;e++)i.appendChild(Switch({labelText:Object.keys(this.Columns)[e],attrs:{checked:""},evts:{change:function(){const a=o.HeadingsContainer.querySelectorAll("hcol-rui")[e+1],s=o.RowsContainer.querySelectorAll(`[data-colindex="${e}"]`);if(this.checked){a.classList.remove("hide");for(const e of s)e.classList.remove("hide");t.value=+t.value-1}else{a.classList.add("hide");for(const e of s)e.classList.add("hide");t.value=+t.value+1}+t.value>0?n.classList.remove("hide"):n.classList.add("hide")}}}));const l=document.createElement("panel-footer-rui"),r=i.querySelectorAll("input"),d=document.createElement("button");d.type="button",d.className="panel-btn",d.textContent="HIDE ALL",d.addEventListener("click",(()=>{for(const e of r)e.checked&&e.click()}));const c=document.createElement("button");c.type="button",c.className="panel-btn",c.textContent="SHOW ALL",c.addEventListener("click",(()=>{for(const e of r)e.checked||e.click()})),l.appendChild(d),l.appendChild(c),a.appendChild(s),a.appendChild(i),a.appendChild(l),t.addEventListener("click",(e=>{if(this.Toolbar.querySelector("toolbar-panel-rui.filters").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[1].click(),this.Toolbar.querySelector("toolbar-panel-rui.sorts").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[2].click(),!a.classList.contains("hide"))return;e.stopPropagation(),a.classList.toggle("hide"),s.querySelector("input").focus();const t=e=>{-1===this.ElemIsDescendantOf(e.target,a)&&(a.classList.add("hide"),window.removeEventListener("click",t))};window.addEventListener("click",t)})),e.appendChild(t),e.appendChild(a),this.Toolbar.appendChild(e)}SetOperatorVisibility(e){const t=e.querySelectorAll("[data-operators]");if(1!==t.length)for(let e=0;e<t.length;e++)0===e?t[e].className="mr-_5 invisible":1===e?(t[e].className="mr-_5",t[e].children[0].removeAttribute("disabled")):(t[e].className="mr-_5",t[e].children[0].setAttribute("disabled",""));else t[0].className="mr-_5 hidden"}CreateFilterRow(e,t,n){const a=this,s=document.createElement("row-rui"),i=document.createElement("div");i.setAttribute("delete-row","");const o=document.createElement("button");o.type="button",o.innerHTML="&times;",o.addEventListener("click",(function(s){const i=+e.getAttribute("data-rows");if(i>1){s.stopPropagation();const o=this.parentElement.parentElement;o.hasAttribute("data-has-filter")&&(t.value=+t.value-1,+t.value>0?n.classList.remove("hide"):n.classList.add("hide")),o.remove(),a.SetOperatorVisibility(e),e.setAttribute("data-rows",i-1),a.FilterReadData()}else{const e=this.parentElement.parentElement;if(!e.hasAttribute("data-has-filter"))return;e.removeAttribute("data-has-filter");const s=e.children[2].children[0],i=e.children[3].children[0],o=e.children[4].children[0];s.value=a.Columns[Object.keys(a.Columns)[0]].dbName,i.value=a.Operations[0].value,i.setAttribute("data-value",a.Operations[0].value),o.value=null,o.parentElement.classList.remove("invisible"),t.value=+t.value-1,+t.value>0?n.classList.remove("hide"):n.classList.add("hide"),a.FilterReadData()}})),i.appendChild(o);const l=Select({labelText:"Operators",attrs:{class:"w8"},evts:{change:function(){const t=e.querySelectorAll("[data-operators]");for(const e of t)e.children[0].value=this.value;this.parentElement.parentElement.hasAttribute("data-has-filter")&&a.FilterReadData()}},options:[{value:"AND",textContent:"And"},{value:"OR",textContent:"Or"}]});if(l.setAttribute("data-operators",""),l.className="mr-_5 hidden",e.children.length>0){"AND"===e.lastElementChild.children[1].children[0].value?l.children[0].value="AND":l.children[0].value="OR"}const r=[];for(const e in this.Columns)r.push({value:this.Columns[e].dbName,textContent:e});const d=Select({labelText:"Columns",attrs:{class:"w14"},evts:{change:function(){this.parentElement.parentElement.hasAttribute("data-has-filter")&&a.FilterReadData()}},options:r});d.classList.add("mr-_5");const c=Select({labelText:"Operations",attrs:{class:"w17","data-value":this.Operations[0].value},evts:{change:function(){const e=this.parentElement.nextElementSibling.children[0],s=this.parentElement.parentElement;"isEmpty"===this.value||"isNotEmpty"===this.value?(e.parentElement.classList.add("invisible"),e.value=null,s.hasAttribute("data-has-filter")||(s.setAttribute("data-has-filter",""),t.value=+t.value+1),a.FilterReadData()):"isEmpty"===this.getAttribute("data-value")||"isNotEmpty"===this.getAttribute("data-value")?(e.parentElement.classList.remove("invisible"),s.removeAttribute("data-has-filter"),t.value=+t.value-1,a.FilterReadData()):e.value&&a.FilterReadData(),this.setAttribute("data-value",this.value),+t.value>0?n.classList.remove("hide"):n.classList.add("hide")}},options:this.Operations});c.classList.add("mr-_5"),s.appendChild(i),s.appendChild(l),s.appendChild(d),s.appendChild(c),s.appendChild(Input({attrs:{class:"w18",placeholder:"Filter Value"},evts:{input:function(){clearTimeout(a.FilterTimer),a.FilterTimer=setTimeout((()=>{this.value?this.parentElement.parentElement.hasAttribute("data-has-filter")||(this.parentElement.parentElement.setAttribute("data-has-filter",""),t.value=+t.value+1):(this.parentElement.parentElement.removeAttribute("data-has-filter"),t.value=+t.value-1),+t.value>0?n.classList.remove("hide"):n.classList.add("hide"),a.FilterReadData()}),1e3)}}})),e.appendChild(s);const u=+e.getAttribute("data-rows");e.setAttribute("data-rows",u+1)}CreateFiltersPanelContainer(){const e=document.createElement("toolbar-panel-container-rui"),t=document.createElement("button");t.type="button",t.value=0,t.className="toolbar-btn",t.innerHTML='<i class="fas fa-filter"></i> Filters';const n=document.createElement("indicator-rui");n.className="hide",t.appendChild(n);const a=document.createElement("toolbar-panel-rui");a.className="filters hide";const s=document.createElement("panel-content-rui");s.setAttribute("data-rows",0),this.CreateFilterRow(s,t,n);const i=document.createElement("panel-footer-rui"),o=document.createElement("button");o.type="button",o.className="panel-btn",o.innerHTML='<i class="fas fa-plus"></i> ADD FILTER',o.addEventListener("click",(()=>{this.CreateFilterRow(s,t,n),this.SetOperatorVisibility(s)})),i.appendChild(o),a.appendChild(s),a.appendChild(i),t.addEventListener("click",(e=>{if(this.Toolbar.querySelector("toolbar-panel-rui.columns").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[0].click(),this.Toolbar.querySelector("toolbar-panel-rui.sorts").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[2].click(),!a.classList.contains("hide"))return;e.stopPropagation(),a.classList.remove("hide"),s.querySelector("input").focus();const t=e=>{-1===this.ElemIsDescendantOf(e.target,a)&&(a.classList.add("hide"),window.removeEventListener("click",t))};window.addEventListener("click",t)})),e.appendChild(t),e.appendChild(a),this.Toolbar.appendChild(e)}CreateSortsPanelContainer(){const e=document.createElement("toolbar-panel-container-rui"),t=document.createElement("button");t.type="button",t.value=0,t.className="toolbar-btn",t.innerHTML='<i class="fas fa-sort"></i> Sorts';const n=document.createElement("indicator-rui");n.className="hide",t.appendChild(n);const a=document.createElement("toolbar-panel-rui");a.className="sorts hide";const s=document.createElement("panel-header-rui");s.appendChild(Input({attrs:{type:"text",placeholder:"Find Column"},evts:{input:function(){const e=a.querySelectorAll("row-rui"),t=this.value.trim().toLowerCase();for(const n of e){n.children[1].textContent.trim().toLowerCase().indexOf(t)>-1?n.classList.remove("hide"):n.classList.add("hide")}}}}));const i=document.createElement("panel-content-rui"),o=(e,n)=>{e.removeAttribute("data-has-sort"),n.disabled=!0,n.value=null,n.removeAttribute("data-value");for(let e=0;e<+t.value;e++)n.children[e].disabled=!0},l=[];for(let e=0;e<Object.keys(this.Columns).length;e++)l.push({value:e+1,textContent:e+1,disabled:""});const r=this;for(let e=0;e<Object.keys(this.Columns).length;e++){const s=document.createElement("row-rui"),d=Select({labelText:"Order",attrs:{"data-order":"",disabled:""},evts:{change:function(){const e=a.querySelector(`[data-value="${this.value}"]`);e.value=this.getAttribute("data-value"),e.setAttribute("data-value",this.getAttribute("data-value")),this.setAttribute("data-value",this.value),r.ReadData()}},options:l});d.classList.add("mr-_5");const c=document.createElement("span");c.textContent=Object.keys(this.Columns)[e],c.title=Object.keys(this.Columns)[e],c.setAttribute("data-column",this.Columns[Object.keys(this.Columns)[e]].dbName),c.className="mr-_5";const u=Select({labelText:"Direction",attrs:{"data-direction":"",class:"w12"},evts:{change:function(){const e=this.parentElement.parentElement,s=e.children[0].children[0];if("ASC"===this.value||"DESC"===this.value){e.hasAttribute("data-has-sort")||(t.value=+t.value+1,+t.value>0?n.classList.remove("hide"):n.classList.add("hide")),e.setAttribute("data-has-sort",""),s.disabled=!1;const i=a.querySelectorAll("[data-has-sort] [data-order]");for(const e of i)for(let n=0;n<+t.value;n++)e.children[n].disabled=!1;s.value=t.value,s.setAttribute("data-value",t.value)}else{const i=+s.value;o(e,s),t.value=+t.value-1,+t.value>0?n.classList.remove("hide"):n.classList.add("hide");const l=a.querySelectorAll("[data-has-sort] [data-order]");for(const e of l)+e.value>i&&(e.value=+e.value-1,e.setAttribute("data-value",e.value)),e.children[+t.value].disabled=!0}r.ReadData()}},options:[{value:"unsorted",textContent:"Unsorted"},{value:"ASC",textContent:"Ascending"},{value:"DESC",textContent:"Descending"}]});u.classList.add("mr-_5"),s.appendChild(d),s.appendChild(c),s.appendChild(u),i.appendChild(s)}const d=document.createElement("panel-footer-rui"),c=document.createElement("button");c.type="button",c.className="panel-btn",c.textContent="RESET ALL",c.addEventListener("click",(function(){const e=a.querySelectorAll("[data-has-sort]");if(0!==e.length){for(const t of e){const e=t.children[0].children[0];t.children[2].children[0].value="unsorted",o(t,e)}t.value=0,n.classList.add("hide"),r.ReadData()}})),d.appendChild(c),a.appendChild(s),a.appendChild(i),a.appendChild(d),t.addEventListener("click",(e=>{if(this.Toolbar.querySelector("toolbar-panel-rui.columns").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[0].click(),this.Toolbar.querySelector("toolbar-panel-rui.filters").classList.contains("hide")||this.Toolbar.querySelectorAll(".toolbar-btn")[1].click(),!a.classList.contains("hide"))return;e.stopPropagation(),a.classList.remove("hide");const t=e=>{-1===this.ElemIsDescendantOf(e.target,a)&&(a.classList.add("hide"),window.removeEventListener("click",t))};window.addEventListener("click",t)})),e.appendChild(t),e.appendChild(a),this.Toolbar.appendChild(e)}HTMLStringToNode(e){const t=document.createElement("div");return t.innerHTML=e,t.children}CreateNewModal(){this.NewModal=document.createElement("rwc-modal"),this.NewModal.modalOutlineColor="hsl(93, 98%, 30%)",this.NewModal.innerHTML=`\n            <span slot="heading">Add New ${this.TableName}</span>\n            <div slot="body-content"><form></form></div>\n        `;const e=this.NewModal.querySelector("form");for(const t in this.Columns)switch(this.Columns[t].tagName){case"input":e.appendChild(Input(this.Columns[t].tag));break;case"textarea":e.appendChild(Textarea(this.Columns[t].tag));break;case"select":e.appendChild(Select(this.Columns[t].tag));break;default:}e.append(...this.HTMLStringToNode('\n            <div class="reset-submit">\n                <button type="reset" class="red">RESET</button>\n                <button type="submit" class="green">SUBMIT</button>\n            </div>\n        '));const t=this;e.addEventListener("submit",(function(e){e.preventDefault(),t.Alert.closeAlert();const n=new FormData(this);n.append("REQUEST_ACTION","CREATE"),fetch(t.CrudUrl,{method:"POST",body:n}).then((e=>e.json())).then((e=>{if(e.success)t.NewModal.querySelector("form").reset(),t.ReadData(),t.Alert.innerHTML=`\n                            <span slot="status">Success!</span>\n                            <span slot="message">${e.message}</span>\n                        `,t.Alert.alertColor="#bdd9a6",t.Alert.openAlert();else{const n="object"==typeof e.message?"Invalid data detected! Please remove invalid data and submit again.":"Something went wrong. Please try again later.";t.Alert.innerHTML=`\n                            <span slot="status">Failure!</span>\n                            <span slot="message">${n}</span>\n                        `,t.Alert.alertColor="#d9a6af",t.Alert.openAlert()}})).catch((e=>{}))})),document.body.appendChild(this.NewModal);const n=this.HTMLStringToNode('\n            <button type="button" class="toolbar-btn new">\n                <i class="fas fa-plus"></i> New\n            </button>\n        ')[0];n.addEventListener("click",(()=>this.NewModal.openModal())),this.Toolbar.appendChild(n)}CreateDeleteModal(){this.DeleteModal=document.createElement("rwc-modal"),this.DeleteModal.modalOutlineColor="hsl(349, 84%, 65%)",this.DeleteModal.innerHTML='\n            <span slot="heading"></span>\n            <div slot="body-content">\n                <div class="body-text"></div>\n                <form>\n                    <div class="reset-submit">\n                        <button type="reset" class="green">CANCEL</button>\n                        <button type="submit" class="red">DELETE</button>\n                    </div>\n                </form>\n            </div>\n        ',document.body.appendChild(this.DeleteModal),this.DeleteModal.querySelector('button[type="reset"]').addEventListener("click",(()=>this.DeleteModal.Modal.classList.remove("open")));const e=this;this.DeleteModal.querySelector("form").addEventListener("submit",(function(t){t.preventDefault(),e.Alert.closeAlert();const n=[],a=e.RowsContainer.querySelectorAll("row-rui.selected");for(const e of a)n.push(+e.getAttribute("data-entity-id"));const s=new FormData;s.append("REQUEST_ACTION","DELETE"),s.append("ids",JSON.stringify(n)),fetch(e.CrudUrl,{method:"POST",body:s}).then((e=>e.json())).then((t=>{if(t.success)e.DeleteModal.closeModal(),e.ReadData(),e.Alert.innerHTML=`\n                            <span slot="status">Success!</span>\n                            <span slot="message">${t.message}</span>\n                        `,e.Alert.alertColor="#bdd9a6",e.Alert.openAlert();else{const n="Invalid ID(s)!"===t.message?"Invalid ID(s) detected! Please remove invalid ID(s) and try again.":"Something went wrong. Please try again later.";e.Alert.innerHTML=`\n                            <span slot="status">Failure!</span>\n                            <span slot="message">${n}</span>\n                        `,e.Alert.alertColor="#d9a6af",e.Alert.openAlert()}})).catch((e=>{}))}));const t=this.HTMLStringToNode('\n            <button type="button" class="toolbar-btn del">\n                <i class="far fa-trash-alt"></i> Delete\n            </button>\n        ')[0];t.addEventListener("click",(()=>{const e=+this.Footer.querySelector("num-selected-rows-rui").textContent.split(" row")[0],t=this.DeleteModal.querySelector('[slot="heading"]'),n=this.DeleteModal.querySelector(".body-text"),a=this.DeleteModal.querySelector('button[type="submit"]');0===e?(t.textContent="No Rows Selected!",n.textContent="Please select some row(s) first then click delete.",a.disabled=!0):(t.textContent="Are You Sure?",n.textContent=`Are you sure you want to permanently delete ${1===e?"1 row":e+" rows"}? This action cannot be undone!`,a.disabled=!1),this.DeleteModal.openModal()})),this.Toolbar.appendChild(t)}CreateMain(){this.Main=document.createElement("main-rui"),this.CreateHeadingsContainer(),this.CreateRowsContainer(),this.DataGrid.appendChild(this.Main)}PxToRem(e){return window.innerWidth>=2700?+e/15:window.innerWidth>=1800?+e/12.5:window.innerWidth>=900?+e/10:+e/7.5}CreateHeadingsContainer(){this.HeadingsContainer=document.createElement("headings-container-rui");const e=document.createElement("headings-rui"),t=document.createElement("hcol-rui");t.className="select-column",t.appendChild(Checkbox({attrs:{"data-checkbox-group-all":"","data-checkbox-selected-count":0}})),e.appendChild(t);for(let t=0;t<Object.keys(this.Columns).length;t++){const n=document.createElement("hcol-rui");n.setAttribute("data-column",this.Columns[Object.keys(this.Columns)[t]].dbName);const a=document.createElement("div");a.textContent=Object.keys(this.Columns)[t],a.style.display="inline-block",a.style.opacity=0,document.body.appendChild(a);const s=this.PxToRem(a.scrollWidth+24);document.body.removeChild(a),n.style.minWidth=s>=5?`${s}rem`:"5rem",n.style.maxWidth=s>=5?`${s}rem`:"5rem";const i=document.createElement("heading-title-rui");i.textContent=Object.keys(this.Columns)[t];const o=document.createElement("resizable-rui");o.setAttribute("data-colindex",t);const l=document.createElement("resizable-icon-rui");o.appendChild(l),n.appendChild(i),n.appendChild(o),e.appendChild(n)}this.HeadingsContainer.appendChild(e),this.Main.appendChild(this.HeadingsContainer)}CreateRowsContainer(){this.RowsContainer=document.createElement("rows-container-rui"),this.BoundColumnNavigate=this.ColumnNavigate.bind(this),this.BoundColumnEdit=this.ColumnEdit.bind(this),this.CreateRows(),this.Main.appendChild(this.RowsContainer),this.RowsContainer.addEventListener("scroll",(()=>{this.HeadingsContainer.children[0].style.transform=`translateX(-${this.RowsContainer.scrollLeft}px)`}))}KeepElementInView(e,t){e.offsetLeft+e.offsetWidth-t.offsetLeft>t.offsetWidth-this.ScrollbarWidth+t.scrollLeft?t.scrollLeft=e.offsetLeft+e.offsetWidth-t.offsetLeft-t.offsetWidth+this.ScrollbarWidth+1:e.offsetLeft-t.offsetLeft<t.scrollLeft&&(t.scrollLeft=e.offsetLeft-t.offsetLeft-1)}ColumnNavigate(e){switch(e.preventDefault(),e.key){case"ArrowUp":this.FocusedCol.parentElement.previousElementSibling&&this.FocusedCol.parentElement.previousElementSibling.querySelector(`[data-colindex="${this.FocusedCol.getAttribute("data-colindex")}"]`).focus();break;case"ArrowDown":this.FocusedCol.parentElement.nextElementSibling&&this.FocusedCol.parentElement.nextElementSibling.querySelector(`[data-colindex="${this.FocusedCol.getAttribute("data-colindex")}"]`).focus();break;case"ArrowLeft":for(let e=this.FocusedCol.previousElementSibling;e.hasAttribute("data-colindex");e=e.previousElementSibling)if(!e.classList.contains("hide")){e.focus(),this.KeepElementInView(this.FocusedCol,this.RowsContainer);break}break;case"ArrowRight":for(let e=this.FocusedCol.nextElementSibling;null!==e;e=e.nextElementSibling)if(!e.classList.contains("hide")){e.focus(),this.KeepElementInView(this.FocusedCol,this.RowsContainer);break}break;case"Home":for(let e=this.FocusedCol.parentElement.querySelector('[data-colindex="0"]');null!==e;e=e.nextElementSibling)if(!e.classList.contains("hide")){e.focus(),this.KeepElementInView(this.FocusedCol,this.RowsContainer);break}break;case"End":for(let e=this.FocusedCol.parentElement.querySelector(`[data-colindex="${this.FocusedCol.parentElement.children.length-2}"]`);e.hasAttribute("data-colindex");e=e.previousElementSibling)if(!e.classList.contains("hide")){e.focus(),this.KeepElementInView(this.FocusedCol,this.RowsContainer);break}break;case"PageUp":this.RowsContainer.querySelector(`[data-rowindex="0"] [data-colindex="${this.FocusedCol.getAttribute("data-colindex")}"]`).focus();break;case"PageDown":this.RowsContainer.querySelector(`[data-rowindex="${+this.Pagination.querySelector("offset-max-rui").textContent-1}"] [data-colindex="${this.FocusedCol.getAttribute("data-colindex")}"]`).focus();break;case"Enter":"INPUT"===this.FocusedCol.tagName?this.FocusedCol.dispatchEvent(new MouseEvent("dblclick")):this.FocusedCol.dispatchEvent(new MouseEvent("click"));break;default:}}ColumnEdit(e){if("Escape"!==e.key&&"Enter"!==e.key)return;let t=!1;if(this.FocusedCol.nextElementSibling)for(let e=this.FocusedCol.nextElementSibling;null!==e;e=e.nextElementSibling)if(!e.classList.contains("hide")){e.focus(),t=!0;break}if(!t&&this.FocusedCol.parentElement.nextElementSibling)for(let e=this.FocusedCol.parentElement.nextElementSibling.querySelector('[data-colindex="0"]');null!==e;e=e.nextElementSibling)if(!e.classList.contains("hide")){e.focus(),t=!0;break}t||(this.FocusedCol.blur(),this.FocusedCol.focus()),this.KeepElementInView(this.FocusedCol,this.RowsContainer)}ResizeColumn(e,t){const n=this.PxToRem(t),a=this.HeadingsContainer.children[0].children[+e.getAttribute("data-colindex")+1],s=this.RowsContainer.querySelectorAll(`[data-colindex="${e.getAttribute("data-colindex")}"]`);a.style.minWidth=`${n}rem`,a.style.maxWidth=`${n}rem`;for(const e of s)e.style.minWidth=`${n}rem`,e.style.maxWidth=`${n}rem`}CreateInputCols(e,t,n){const a=this,s=document.createElement("input");return s.setAttribute("data-colindex",t),s.value=this.Rows[e][n]?this.Rows[e][n]:"",s.setAttribute("data-value",this.Rows[e][n]?this.Rows[e][n]:""),s.readOnly=!0,s.addEventListener("focus",(function(){a.FocusedCol=this})),s.addEventListener("keydown",this.BoundColumnNavigate),s.addEventListener("blur",(function(){if(this.readOnly)return;if(this.readOnly=!0,this.removeEventListener("keydown",a.BoundColumnEdit),this.addEventListener("keydown",a.BoundColumnNavigate),this.value===this.getAttribute("data-value"))return;a.Alert.closeAlert();const e=new FormData;e.append("REQUEST_ACTION","UPDATE"),e.append("id",+this.parentElement.getAttribute("data-entity-id")),e.append("column",a.HeadingsContainer.children[0].children[+this.getAttribute("data-colindex")+1].getAttribute("data-column")),e.append("value",this.value),fetch(a.CrudUrl,{method:"POST",body:e}).then((e=>e.json())).then((e=>{if(e.success)this.setAttribute("data-value",this.value),a.Alert.innerHTML=`\n                            <span slot="status">Success!</span>\n                            <span slot="message">${e.message}</span>\n                        `,a.Alert.alertColor="#bdd9a6",a.Alert.openAlert();else{const t="Invalid column data"===e.message?"Invalid column data detected! Please remove invalid data and submit again.":"Something went wrong. Please try again later.";a.Alert.innerHTML=`\n                            <span slot="status">Failure!</span>\n                            <span slot="message">${t}</span>\n                        `,a.Alert.alertColor="#d9a6af",a.Alert.openAlert()}})).catch((e=>{}))})),s.addEventListener("dblclick",(function(){this.readOnly&&(this.scrollWidth>this.offsetWidth&&a.ResizeColumn(this,this.scrollWidth+10),this.removeEventListener("keydown",a.BoundColumnNavigate),this.readOnly=!1,this.setSelectionRange(this.value.length,this.value.length),a.KeepElementInView(this,a.RowsContainer),this.addEventListener("keydown",a.BoundColumnEdit))})),s}CreateInputFileImageCols(e,t,n){const a=this;let s=null;return this.Rows[e][n]?(s=this.HTMLStringToNode(`\n                <div class="image" data-colindex="${t}" tabindex="0">\n                    <label>\n                        <input type="file" name="${n}" accept="image/*">\n                        <img src="${this.Rows[e][n]}" ${e<=3?'class="top"':""}>\n                    </label>\n                    <button type="button" title="Remove image">&times;</button>\n                </div>\n            `)[0],s.style.zIndex=e<=3?-1*(e-3):"",s.querySelector("button").addEventListener("click",(function(){const t=new FormData;t.append("REQUEST_ACTION","UPDATE"),t.append("id",+a.RowIDs[e][Object.keys(a.RowIDs[e])[0]]),t.append("column",n),t.append("value",""),t.append(n,new File([],"")),fetch(a.CrudUrl,{method:"POST",body:t}).then((e=>e.json())).then((e=>{if(e.success)a.ReadData(),a.Alert.innerHTML=`\n                                <span slot="status">Success!</span>\n                                <span slot="message">${e.message}</span>\n                            `,a.Alert.alertColor="#bdd9a6",a.Alert.openAlert();else{const t="Invalid column data"===e.message?"Image upload failed! Please try to upload the image again.":"Something went wrong. Please try again later.";a.Alert.innerHTML=`\n                                <span slot="status">Failure!</span>\n                                <span slot="message">${t}</span>\n                            `,a.Alert.alertColor="#d9a6af",a.Alert.openAlert()}}))}))):s=this.HTMLStringToNode(`\n                <label class="image" data-colindex="${t}" tabindex="0">\n                    <input type="file" name="${n}" accept="image/*">\n                </label>\n            `)[0],s.addEventListener("focus",(function(){a.FocusedCol=this})),s.addEventListener("keydown",this.BoundColumnNavigate),s.querySelector("input").addEventListener("change",(function(){const t=new FormData;t.append("REQUEST_ACTION","UPDATE"),t.append("id",+a.RowIDs[e][Object.keys(a.RowIDs[e])[0]]),t.append("column",n),t.append("value",this.value),t.append(n,this.files[0]),fetch(a.CrudUrl,{method:"POST",body:t}).then((e=>e.json())).then((e=>{if(e.success)a.ReadData(),a.Alert.innerHTML=`\n                            <span slot="status">Success!</span>\n                            <span slot="message">${e.message}</span>\n                        `,a.Alert.alertColor="#bdd9a6",a.Alert.openAlert();else{const t="Invalid column data"===e.message||"Error uploading file"===e.message?"Image upload failed! Please try to upload the image again.":"Something went wrong. Please try again later.";a.Alert.innerHTML=`\n                            <span slot="status">Failure!</span>\n                            <span slot="message">${t}</span>\n                        `,a.Alert.alertColor="#d9a6af",a.Alert.openAlert()}}))})),s}CreateRows(){this.RowsContainer.innerHTML=null;for(let e=0;e<this.Rows.length;e++){const t=document.createElement("row-rui");t.setAttribute("data-rowindex",e),t.setAttribute("data-entity-id",this.RowIDs[e][Object.keys(this.RowIDs[e])[0]]);const n=document.createElement("col-rui");n.className="select-column",n.appendChild(Checkbox({attrs:{"data-checkbox-group-single":""}})),t.appendChild(n);let a=0;for(let n in this.Rows[e]){"images"===this.Columns[Object.keys(this.Columns)[a]].otherInfo?t.appendChild(this.CreateInputFileImageCols(e,a,n)):t.appendChild(this.CreateInputCols(e,a,n)),a++}this.RowsContainer.appendChild(t)}}CreateFooter(){this.Footer=document.createElement("footer-rui");const e=document.createElement("num-selected-rows-rui");e.textContent="0 rows selected",this.Footer.appendChild(e),this.CreatePagination(),this.DataGrid.appendChild(this.Footer)}CreatePagination(){this.Pagination=document.createElement("pagination-rui");const e=document.createElement("p");e.className="rows-per-page",e.textContent="Rows per page:";const t=document.createElement("displayed-rows-rui");t.innerHTML=`<offset-min-rui>${this.NumRows>0?1:0}</offset-min-rui>-<offset-max-rui>${this.NumRows>=this.RPPDV?this.RPPDV:this.NumRows}</offset-max-rui> of <num-rows-rui>${this.NumRows}</num-rows-rui>`;this.Pagination.appendChild(e),this.Pagination.appendChild((()=>{const e=[];for(const t of this.RPPVs)t===this.RPPDV?e.push({value:t,textContent:t,selected:""}):e.push({value:t,textContent:t});const t=this;return Select({attrs:{"data-rows-per-page-value":""},evts:{change:function(){const e=t.DataGrid.querySelector("offset-min-rui"),n=t.DataGrid.querySelector("offset-max-rui"),a=t.DataGrid.querySelector('button[title="Go to next page"]'),s=+e.textContent+ +this.value-1;s<=t.NumRows?n.textContent=s:n.textContent=t.NumRows,+n.textContent===t.NumRows?a.disabled=!0:a.disabled=!1,t.ReadData()}},options:e})})()),this.Pagination.appendChild(t),this.Pagination.appendChild((()=>{const e=document.createElement("pagination-actions-rui");return this.PrevPageBtn=document.createElement("button"),this.PrevPageBtn.type="button",this.PrevPageBtn.title="Go to previous page",this.PrevPageBtn.disabled=!0,this.PrevPageBtn.innerHTML='<i class="fas fa-chevron-left"></i>',this.NextPageBtn=document.createElement("button"),this.NextPageBtn.type="button",this.NextPageBtn.title="Go to next page",this.NextPageBtn.disabled=this.NumRows<=this.RPPDV,this.NextPageBtn.innerHTML='<i class="fas fa-chevron-right"></i>',e.appendChild(this.PrevPageBtn),e.appendChild(this.NextPageBtn),e})()),this.Footer.appendChild(this.Pagination)}SizeColumns(){const e=this.HeadingsContainer.querySelectorAll("hcol-rui"),t=this.RowsContainer.querySelectorAll("row-rui");for(const n of t)for(let t=1;t<n.children.length;t++)n.children[t].style.minWidth=e[t].style.minWidth,n.children[t].style.maxWidth=e[t].style.maxWidth}HideColumns(){const e=this.HeadingsContainer.querySelectorAll("hcol-rui.hide");for(const t of e){const e=+t.children[1].getAttribute("data-colindex"),n=this.RowsContainer.querySelectorAll(`[data-colindex="${e}"]`);for(const e of n)e.classList.add("hide")}}SetupAllCheckbox(){const e=this.DataGrid.querySelector("[data-checkbox-group-all]"),t=this;e.addEventListener("change",(function(){const e=t.RowsContainer.querySelectorAll("[data-checkbox-group-single]");if(this.checked)for(const t of e)t.checked||t.click();else for(const t of e)t.checked&&t.click()}))}SetupCheckboxes(){const e=this.DataGrid.querySelector("[data-checkbox-group-all]"),t=e.nextElementSibling,n=this.DataGrid.querySelectorAll("[data-checkbox-group-single]"),a=this.DataGrid.querySelector("num-selected-rows-rui"),s=this;for(let i=0;i<n.length;i++)n[i].addEventListener("change",(function(){let o=+e.getAttribute("data-checkbox-selected-count");this.checked?(s.RowsContainer.children[i].classList.add("selected"),o++,e.setAttribute("data-checkbox-selected-count",o)):(s.RowsContainer.children[i].classList.remove("selected"),o--,e.setAttribute("data-checkbox-selected-count",o)),0===o?(e.checked=!1,t.className="far fa-square icon"):o===n.length?(e.checked=!0,t.className="fas fa-check-square icon checked"):(e.checked=!0,t.className="fas fa-minus-square icon checked"),a.textContent=1===o?`${o} row selected`:`${o} rows selected`}))}SetupResizingColumns(){const e=this,t=this.DataGrid.querySelector("headings-rui"),n=t.querySelectorAll("resizable-rui"),a={x:0,colIndex:0,minWidth:5,minLeft:0},s=e=>{const n=t.querySelectorAll("hcol-rui")[a.colIndex+1],s=n.getBoundingClientRect().width;if(this.PxToRem(s)===a.minWidth&&(a.minLeft=a.minLeft<0?e.clientX:a.minLeft),e.clientX<a.minLeft)return;const i=e.clientX-a.x;a.x=e.clientX;const o=this.PxToRem(s+i);if(o<a.minWidth)return;n.style.minWidth=`${o}rem`,n.style.maxWidth=`${o}rem`;const l=this.RowsContainer.querySelectorAll(`[data-colindex="${a.colIndex}"]`);for(let e of l)e.style.minWidth=`${o}rem`,e.style.maxWidth=`${o}rem`},i=()=>{t.querySelector("resizable-rui.active").classList.remove("active"),window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",i)};for(let t=0;t<n.length;t++)n[t].addEventListener("mousedown",(function(e){a.x=e.clientX,a.colIndex=+this.getAttribute("data-colindex"),a.minLeft=-1,this.classList.add("active"),window.addEventListener("mousemove",s),window.addEventListener("mouseup",i)})),n[t].addEventListener("dblclick",(function(t){let n=this.previousElementSibling.scrollWidth;const a=e.RowsContainer.querySelectorAll(`[data-colindex="${this.getAttribute("data-colindex")}"]`);for(const e of a)e.scrollWidth+1>n&&(n=e.scrollWidth+1);n>this.previousElementSibling.offsetWidth&&e.ResizeColumn(a[0],n+10)}))}SetupNextPrevBtns(){const e=this.Pagination.querySelector("[data-rows-per-page-value]"),t=this.Pagination.querySelector("offset-min-rui"),n=this.Pagination.querySelector("offset-max-rui"),a=this;this.NextPageBtn.addEventListener("click",(function(){const s=+t.textContent+ +e.value,i=+n.textContent+ +e.value;s>a.NumRows?+e.value<=a.NumRows&&(t.textContent=s):t.textContent=s,i>a.NumRows?(n.textContent=a.NumRows,this.disabled=!0):n.textContent=i,a.PrevPageBtn.disabled=!1,a.ReadData()})),this.PrevPageBtn.addEventListener("click",(function(){const s=+t.textContent-+e.value;let i=+n.textContent-+e.value,o=!1;this.disabled=s<=1,s<1?a.NumRows>0?t.textContent=1:t.textContent=0:t.textContent=s,+n.textContent===a.NumRows?(i=+t.textContent+ +e.value-1,i>a.NumRows?(n.textContent=a.NumRows,o=!0):n.textContent=i):n.textContent=i,+n.textContent-+t.textContent+1<+e.value&&+e.value<=a.NumRows&&(n.textContent=+t.textContent+ +e.value-1),a.NextPageBtn.disabled=o,a.ReadData()}))}ResetRowsSelected(){const e=this.DataGrid.querySelector("[data-checkbox-group-all]");+e.getAttribute("data-checkbox-selected-count")>0&&e.click()}ElemIsDescendantOf(e,t){if(e===t)return 0;for(let n=e.parentElement;null!==n;n=n.parentElement)if(n===t)return 1;return-1}GetFilters(){const e=this.Toolbar.querySelectorAll("toolbar-panel-rui.filters row-rui[data-has-filter]"),t=[];for(let n=0;n<e.length;n++){const a={operator:!1,column:e[n].children[2].children[0].value,operation:e[n].children[3].children[0].value,filterValue:e[n].children[4].children[0].value};n>0&&(a.operator=e[n].children[1].children[0].value),t.push(a)}return JSON.stringify(t)}GetSorts(){const e=this.Toolbar.querySelectorAll("toolbar-panel-rui.sorts row-rui[data-has-sort]"),t=[];for(const n of e)t.push({order:n.children[0].children[0].value,column:n.children[1].getAttribute("data-column"),direction:n.children[2].children[0].value});return t.sort(((e,t)=>+e.order-+t.order)),JSON.stringify(t)}ReadData(){const e=new FormData;e.append("REQUEST_ACTION","READ"),e.append("sorts",this.GetSorts()),e.append("filters",this.GetFilters()),e.append("limit",this.Pagination.querySelector("[data-rows-per-page-value]").value),e.append("offset",this.Pagination.querySelector("offset-min-rui").textContent-1),fetch(this.CrudUrl,{method:"POST",body:e}).then((e=>e.json())).then((e=>{this.Rows=e.rows,this.RowIDs=e.rowIds,this.NumRows!==e.numRows&&(this.NumRows=e.numRows,this.Pagination.querySelector("num-rows-rui").textContent=this.NumRows),0===e.numRows&&(this.Pagination.querySelector("offset-min-rui").textContent=0,this.Pagination.querySelector("offset-max-rui").textContent=0),e.numRows<=+this.Pagination.querySelector("[data-rows-per-page-value]").value&&(this.NextPageBtn.disabled=!0,this.Pagination.querySelector("offset-max-rui").textContent=e.numRows),this.ResetRowsSelected(),this.CreateRows(),this.SizeColumns(),this.HideColumns(),this.SetupCheckboxes()})).catch((e=>{}))}FilterReadData(){this.Pagination.querySelector("offset-min-rui").textContent=1,this.Pagination.querySelector("offset-max-rui").textContent=this.Pagination.querySelector("[data-rows-per-page-value]").value,this.PrevPageBtn.disabled=!0,this.NextPageBtn.disabled=!1,this.ReadData()}}